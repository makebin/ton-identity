!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).TonIdentity=t()}(this,(function(){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(){var e=document.createElement("canvas"),t=e.getContext("2d");t.textBaseline="top",t.font="14px Arial",t.textBaseline="alphabetic",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.fillText("Hello, world!",2,15),t.fillStyle="rgba(102, 204, 0, 0.7)",t.fillText("Hello, world!",4,17);for(var n=e.toDataURL(),r=0,i=0;i<n.length;i++){r=(r<<5)-r+n.charCodeAt(i),r|=0}return r}function i(){var e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return null;var n=t.getExtension("WEBGL_debug_renderer_info");if(!n)return null;var r=t.getParameter(n.UNMASKED_RENDERER_WEBGL),i=t.getParameter(n.UNMASKED_VENDOR_WEBGL);return"".concat(r," ").concat(i)}function o(){var e=navigator.userAgent,t=screen,o=t.width,a=t.height,c=Intl.DateTimeFormat().resolvedOptions().timeZone,u=navigator.language||navigator.userLanguage,s=navigator.connection||navigator.mozConnection||navigator.webkitConnection,l=s.effectiveType,f=s.downlink,d=s.rtt,g=navigator.hardwareConcurrency,p=navigator.deviceMemory,v=navigator.cookieEnabled,h=!!window.WebGLRenderingContext,y=!!("serviceWorker"in navigator),m=!!("PushManager"in window);return{info:n(n(n(n(n(n(n(n(n(n({userAgent:e,screen:{width:o,height:a},timeZone:c,language:u,getWebGLFingerprint:i(),getCanvasFingerprint:r(),connection:s},"connection",{effectiveType:l,downlink:f,rtt:d}),"hardwareConcurrency",g),"deviceMemory",p),"cookiesEnabled",v),"supportsWebGL",h),"supportsServiceWorkers",y),"supportsPushNotifications",m),"time",(new Date).getTime()),"url",window.location.href),"referrer",document.referrer),base64:function(){return btoa(JSON.stringify(this.info))}}}var a=t(Object.freeze({__proto__:null,default:o})),c=console.log,u=function e(t,n){if(t.length<3)return t;var r=t.reduce((function(e,t,n,r){var i=l(t,r[0],r[r.length-1]);return i>e.distance?{distance:i,index:n}:e}),{distance:0,index:0});if(r.distance>n){var i=e(t.slice(0,r.index+1),n),o=e(t.slice(r.index),n);return i.slice(0,-1).concat(o)}return[t[0],t[t.length-1]]},s=function(e){if(!e){var t=new Date;t.setHours(0,0,0,0),e=parseInt(t.getTime()/1e3)}return parseInt((new Date).getTime()/1e3-e,10)},l=function(e,t,n){var r=Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2);if(0===r)return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2));var i=((e.x-t.x)*(n.x-t.x)+(e.y-t.y)*(n.y-t.y))/r,o=Math.max(0,Math.min(1,i)),a=t.x+o*(n.x-t.x),c=t.y+o*(n.y-t.y);return Math.sqrt(Math.pow(e.x-a,2)+Math.pow(e.y-c,2))};function f(e){this.config=e,this.mousePositions=[],this.eventPositions=[],this.regular=null;var t=o().base64(),n=new Image;n.src="".concat(this.config.reportedUrl||"","&base64=").concat(t,"&active=init"),n.onload=function(){},n.onerror=function(){},this.actionListening()}return f.prototype.startRegular=function(){var e=this;this.regular&&clearTimeout(this.regular),this.regular=setTimeout((function(){c("触发自动上报机制!"),e.send()}),this.config.regularTime||1e4)},f.prototype.actionListening=function(){var e=this;c("初始化监听机制"),document.addEventListener("mousemove",(function(t){e.trackMouseMove(t)})),document.addEventListener("click",(function(t){e.trackClick(t)})),document.addEventListener("dblclick",(function(t){e.trackClick(t)})),this.startRegular()},f.prototype.trackClick=function(e){this.eventPositions.push({x:e.clientX,y:e.clientY,t:s(),e:{i:e.target.id,n:e.target.nodeName,t:e.type}})},f.prototype.trackMouseMove=function(e){this.mousePositions.push({x:e.clientX,y:e.clientY,t:s()})},f.prototype.send=function(){var e=this.dataSlice(),t=new Image;t.src="".concat(this.config.reportedUrl||"","&base64=").concat(e,"&active=active"),t.onload=function(){},t.onerror=function(){},this.startRegular()},f.prototype.formatted=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,r=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return e.filter((function(e,n,r){if(0===n)return!0;var i=r[n-1];return Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2))>t}))}(e),i=u(r,n),o="function"==typeof this.config.formatted?this.config.formatted(i):i;return{f:Object.keys(null!==(t=o[0])&&void 0!==t?t:{}),v:o?o.map((function(e){return Object.values(e)})):[]}},f.prototype.dataSlice=function(){var e=this.mousePositions.splice(0,500),t=JSON.stringify(this.formatted(e));c("compressedData=",t);var n=this.eventPositions.splice(0,this.eventPositions.length),r=JSON.stringify(this.formatted(n),15);return c("eventCompressedData=",r),btoa(JSON.stringify({m:t,a:r}))},e({identity:a,reported:t(Object.freeze({__proto__:null,default:f}))})}));
