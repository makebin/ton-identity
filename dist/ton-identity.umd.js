!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).TonIdentity=e()}(this,(function(){"use strict";function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function e(t){if(t.__esModule)return t;var e=t.default;if("function"==typeof e){var n=function t(){return this instanceof t?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};n.prototype=e.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(t).forEach((function(e){var r=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(n,e,r.get?r:{enumerable:!0,get:function(){return t[e]}})})),n}function n(t,e,n){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(){var t=document.createElement("canvas"),e=t.getContext("2d");e.textBaseline="top",e.font="14px Arial",e.textBaseline="alphabetic",e.fillStyle="#f60",e.fillRect(125,1,62,20),e.fillStyle="#069",e.fillText("Hello, world!",2,15),e.fillStyle="rgba(102, 204, 0, 0.7)",e.fillText("Hello, world!",4,17);for(var n=t.toDataURL(),r=0,i=0;i<n.length;i++){r=(r<<5)-r+n.charCodeAt(i),r|=0}return r}function i(){var t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return null;var n=e.getExtension("WEBGL_debug_renderer_info");if(!n)return null;var r=e.getParameter(n.UNMASKED_RENDERER_WEBGL),i=e.getParameter(n.UNMASKED_VENDOR_WEBGL);return"".concat(r," ").concat(i)}function o(){var t=navigator.userAgent,e=screen,o=e.width,a=e.height,c=Intl.DateTimeFormat().resolvedOptions().timeZone,s=navigator.language||navigator.userLanguage,u=navigator.connection||navigator.mozConnection||navigator.webkitConnection,l=u.effectiveType,f=u.downlink,d=u.rtt,g=navigator.hardwareConcurrency,p=navigator.deviceMemory,v=navigator.cookieEnabled,h=!!window.WebGLRenderingContext,y=!!("serviceWorker"in navigator),m=!!("PushManager"in window);return{info:n(n(n(n(n(n(n(n({userAgent:t,screen:{width:o,height:a},timeZone:c,language:s,getWebGLFingerprint:i(),getCanvasFingerprint:r(),connection:u},"connection",{effectiveType:l,downlink:f,rtt:d}),"hardwareConcurrency",g),"deviceMemory",p),"cookiesEnabled",v),"supportsWebGL",h),"supportsServiceWorkers",y),"supportsPushNotifications",m),"time",(new Date).getTime()),base64:function(){return btoa(JSON.stringify(this.info))}}}var a=e(Object.freeze({__proto__:null,default:o})),c=console.log,s=function t(e,n){if(e.length<3)return e;var r=e.reduce((function(t,e,n,r){var i=l(e,r[0],r[r.length-1]);return i>t.distance?{distance:i,index:n}:t}),{distance:0,index:0});if(r.distance>n){var i=t(e.slice(0,r.index+1),n),o=t(e.slice(r.index),n);return i.slice(0,-1).concat(o)}return[e[0],e[e.length-1]]},u=function(t){if(!t){var e=new Date;e.setHours(0,0,0,0),t=parseInt(e.getTime()/1e3)}return parseInt((new Date).getTime()/1e3-t,10)},l=function(t,e,n){var r=Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2);if(0===r)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));var i=((t.x-e.x)*(n.x-e.x)+(t.y-e.y)*(n.y-e.y))/r,o=Math.max(0,Math.min(1,i)),a=e.x+o*(n.x-e.x),c=e.y+o*(n.y-e.y);return Math.sqrt(Math.pow(t.x-a,2)+Math.pow(t.y-c,2))};function f(t){this.config=t,this.mousePositions=[],this.eventPositions=[],this.regular=null;var e=o().base64(),n=new Image;n.src="".concat(this.config.reportedUrl||"","&base64=").concat(e,"&active=init"),n.onload=function(){},n.onerror=function(){},this.actionListening()}return f.prototype.startRegular=function(){var t=this;this.regular&&clearTimeout(this.regular),this.regular=setTimeout((function(){c("触发自动上报机制!"),t.send()}),this.config.regularTime||1e4)},f.prototype.actionListening=function(){var t=this;c("初始化监听机制"),document.addEventListener("mousemove",(function(e){t.trackMouseMove(e)})),document.addEventListener("click",(function(e){t.trackClick(e)})),document.addEventListener("dblclick",(function(e){t.trackClick(e)})),this.startRegular()},f.prototype.trackClick=function(t){this.eventPositions.push({x:t.clientX,y:t.clientY,t:u(),e:{i:t.target.id,n:t.target.nodeName,t:t.type}})},f.prototype.trackMouseMove=function(t){this.mousePositions.push({x:t.clientX,y:t.clientY,t:u()})},f.prototype.send=function(){var t=this.dataSlice(),e=new Image;e.src="".concat(this.config.reportedUrl||"","&base64=").concat(t,"&active=active"),e.onload=function(){},e.onerror=function(){},this.startRegular()},f.prototype.formatted=function(t){var e,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,r=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return t.filter((function(t,n,r){if(0===n)return!0;var i=r[n-1];return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))>e}))}(t),i=s(r,n),o="function"==typeof this.config.formatted?this.config.formatted(i):i;return{f:Object.keys(null!==(e=o[0])&&void 0!==e?e:{}),v:o?o.map((function(t){return Object.values(t)})):[]}},f.prototype.dataSlice=function(){var t=this.mousePositions.splice(0,500),e=JSON.stringify(this.formatted(t));c("compressedData=",e);var n=this.eventPositions.splice(0,this.eventPositions.length),r=JSON.stringify(this.formatted(n),15);return c("eventCompressedData=",r),btoa(JSON.stringify({m:e,a:r}))},t({identity:a,reported:e(Object.freeze({__proto__:null,default:f}))})}));
